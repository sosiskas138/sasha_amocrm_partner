# üìã –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –º–∞–ø–ø–∏–Ω–≥–∞

## üéØ –ß—Ç–æ —ç—Ç–æ?

–§–∞–π–ª `mapping.js` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±—Ö—É–∫–∞ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∫–∞–∫–∏–µ –ø–æ–ª—è Bitrix. –í—Å–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∏—Ö –º–µ–Ω—è—Ç—å.

## üîß –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ?

–û—Ç–∫—Ä–æ–π—Ç–µ `mapping.js` –∏ –Ω–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω–æ–µ –ø–æ–ª–µ Bitrix. –ù–∞–ø—Ä–∏–º–µ—Ä:

```javascript
// –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
NAME: {
  source: 'call.agreements.client_name',  // ‚Üê –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û, —á—Ç–æ–±—ã –±—Ä–∞—Ç—å –∏–∑ –¥—Ä—É–≥–æ–≥–æ –º–µ—Å—Ç–∞
  transform: (value) => {
    return value ? value.trim().split(/\s+/)[0] : '';
  }
},
```

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:

**1. –ü–æ–º–µ–Ω—è—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:**
```javascript
// –ë—ã–ª–æ: –±–µ—Ä–µ–º –∏–º—è –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π
source: 'call.agreements.client_name',

// –°—Ç–∞–ª–æ: –±–µ—Ä–µ–º –∏–º—è –∏–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∫–æ–Ω—Ç–∞–∫—Ç–∞
source: 'contact.additionalFields.name',
```

**2. –ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏ –ø–æ–ª—è:**
```javascript
// –ë—ã–ª–æ: NAME –±–µ—Ä–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ, LAST_NAME - –æ—Å—Ç–∞–ª—å–Ω—ã–µ
NAME: {
  source: 'call.agreements.client_name',
  transform: (value) => value ? value.trim().split(/\s+/)[0] : ''
},
LAST_NAME: {
  source: 'call.agreements.client_name',
  transform: (value) => {
    const parts = value ? value.trim().split(/\s+/) : [];
    return parts.slice(1).join(' ') || '';
  }
},

// –°—Ç–∞–ª–æ: –ø–æ–º–µ–Ω—è–ª–∏ –º–µ—Å—Ç–∞–º–∏ - —Ç–µ–ø–µ—Ä—å NAME –±–µ—Ä–µ—Ç –≤—Å–µ, LAST_NAME - –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
NAME: {
  source: 'call.agreements.client_name',
  transform: (value) => value ? value.trim() : ''  // –í—Å–µ –∏–º—è
},
LAST_NAME: {
  source: 'call.agreements.client_name',
  transform: (value) => value ? value.trim().split(/\s+/)[0] : ''  // –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
},
```

**3. –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:**
```javascript
// –ë—ã–ª–æ: –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏–¥–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "–õ–∏–¥: "
TITLE: {
  source: 'call.agreements.agreements',
  transform: (value, data) => {
    if (value) {
      return `–õ–∏–¥: ${value.substring(0, 100)}`;
    }
    return `–õ–∏–¥ –æ—Ç ${data.callList?.name || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞'}`;
  }
},

// –°—Ç–∞–ª–æ: –Ω–∞–∑–≤–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞, —Ç–æ–ª—å–∫–æ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
TITLE: {
  source: 'call.agreements.agreements',
  transform: (value) => value ? value.substring(0, 100) : '–ù–æ–≤—ã–π –ª–∏–¥'
},
```

## üìç –ü—É—Ç–∏ –∫ –¥–∞–Ω–Ω—ã–º –≤ –≤–µ–±—Ö—É–∫–µ

–î–∞–Ω–Ω—ã–µ –≤ –≤–µ–±—Ö—É–∫–µ –∏–º–µ—é—Ç —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```
{
  contact: {
    phone: "...",
    tags: [...],
    additionalFields: {
      name: "...",
      email: "...",
      website: "..."
    },
    dadataPhoneInfo: {
      region: "...",
      provider: "..."
    }
  },
  call: {
    type: "incoming" | "outgoing",
    status: "...",
    duration: 12345,
    startedAt: "...",
    endedAt: "...",
    agreements: {
      client_name: "...",
      agreements: "...",
      client_facts: "...",
      smsText: "...",
      agreements_time: "..."
    }
  },
  callList: {
    name: "..."
  }
}
```

### –ü—Ä–∏–º–µ—Ä—ã –ø—É—Ç–µ–π:

- `contact.phone` ‚Üí —Ç–µ–ª–µ—Ñ–æ–Ω –∫–æ–Ω—Ç–∞–∫—Ç–∞
- `call.agreements.client_name` ‚Üí –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
- `call.agreements.agreements` ‚Üí –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- `contact.additionalFields.email` ‚Üí email
- `callList.name` ‚Üí –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–ª-–ª–∏—Å—Ç–∞

## üõ†Ô∏è –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### `static` - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ:

```javascript
SOURCE_ID: {
  source: 'static',
  value: 'WEB'  // –í—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç 'WEB'
}
```

### `multiple` - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏):

```javascript
COMMENTS: {
  source: 'multiple',
  transform: (value, data) => {
    // –ó–¥–µ—Å—å —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–µ–π
    const comments = [];
    if (data.call?.agreements?.agreements) {
      comments.push(`–î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: ${data.call.agreements.agreements}`);
    }
    // ... –∏ —Ç.–¥.
    return comments.join('\n\n');
  }
}
```

## ‚ú® –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

–§—É–Ω–∫—Ü–∏—è `transform` –ø–æ–ª—É—á–∞–µ—Ç –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:
1. `value` - –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–∏–ª–∏ `null` –¥–ª—è `multiple`)
2. `data` - –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –≤–µ–±—Ö—É–∫–∞

–ü—Ä–∏–º–µ—Ä—ã:

```javascript
// –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
transform: (value) => value ? value.toUpperCase() : ''

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
transform: (value, data) => {
  const name = data.call?.agreements?.client_name || '';
  return name.split(' ')[0];
}

// –£—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
transform: (value) => {
  if (!value) return null;
  const formatted = value.replace(/\D/g, '');
  return formatted ? [{ VALUE: formatted, VALUE_TYPE: 'MOBILE' }] : null;
}
```

## üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è

–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ Bitrix:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `mapping.js`
2. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ –æ–±—ä–µ–∫—Ç `leadMapping`:

```javascript
const leadMapping = {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  
  // –ù–æ–≤–æ–µ –ø–æ–ª–µ
  YOUR_FIELD_ID: {
    source: 'contact.additionalFields.yourField',  // –û—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å
    transform: (value) => value || ''  // –ö–∞–∫ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  }
};
```

3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

## üîç –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ `source` - –æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤–µ–±—Ö—É–∫–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ - —Ç–∞–º –±—É–¥—É—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ –≤–µ–±—Ö—É–∫–µ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `console.log(data)` –≤ `server.js`)

## üìù –ü—Ä–∏–º–µ—Ä—ã –≥–æ—Ç–æ–≤—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤

–°–º. —Ñ–∞–π–ª `mapping.js` - —Ç–∞–º –µ—Å—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è!
