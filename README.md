# Sasha AI Webhook → amoCRM

Веб-сервер для приема вебхуков от Sasha AI и отправки данных в amoCRM.

## Возможности

- ✅ Прием вебхуков от Sasha AI (события `call_result`)
- ✅ Проверка подписи HMAC SHA-256 для безопасности
- ✅ Автоматическое создание/обновление контактов в amoCRM
- ✅ Создание сделок с привязкой к контактам
- ✅ Гибкая система маппинга полей через конфигурационный файл
- ✅ Поддержка кастомных полей amoCRM
- ✅ Асинхронная обработка (не блокирует ответ)
- ✅ Логирование всех операций

## Установка

1. Установите зависимости:
```bash
npm install
```

2. Скопируйте файл `.env.example` в `.env`:
```bash
cp .env.example .env
```

3. Настройте переменные окружения в файле `.env`:
   - `WEBHOOK_SECRET` - секретный ключ вебхука из панели управления Sasha AI
   - `AMOCRM_SUBDOMAIN` - поддомен вашего аккаунта amoCRM (например, `mycompany` для `mycompany.amocrm.ru`)
   - `AMOCRM_ACCESS_TOKEN` - токен доступа OAuth 2.0 для amoCRM API
   - `AMOCRM_PIPELINE_ID` - ID воронки для создания сделок (обязательно)
   - `AMOCRM_STATUS_ID` - ID статуса в воронке (опционально, по умолчанию первый статус)
   - `PORT` - внешний порт сервера на хосте (по умолчанию `3333`)
   - `CONTAINER_PORT` - внутренний порт Docker контейнера (по умолчанию `3333`)

**Пример настройки портов:**
```env
# Внешний порт (доступен извне)
PORT=8080

# Внутренний порт Docker (обычно совпадает с PORT)
CONTAINER_PORT=3333
```
В этом случае сервер будет доступен на `http://localhost:8080`, а внутри контейнера будет работать на порту `3333`.

## Настройка

### Получение секретного ключа вебхука Sasha AI

1. Перейдите в раздел **Колл-листы** в панели управления Sasha AI
2. Выберите нужный колл-лист
3. В блоке **Вебхуки** нажмите **Создать вебхук**
4. Укажите URL вашего сервера: `https://your-domain.com/webhook`
5. Выберите тип события: **Результат звонка**
6. **Сохраните секретный ключ** - он показывается только один раз!

### Настройка amoCRM

#### 1. Получение токена доступа (OAuth 2.0)

amoCRM использует OAuth 2.0 для авторизации. Для получения токена доступа:

1. Перейдите в раздел **Настройки** → **Интеграции** → **API**
2. Создайте интеграцию или используйте существующую
3. Получите токен доступа (access_token) через OAuth 2.0 flow
4. Укажите токен в переменной окружения `AMOCRM_ACCESS_TOKEN`

**Важно:** Токен имеет ограниченный срок действия. Для продакшена рекомендуется настроить автоматическое обновление токена.

Подробная инструкция по получению токена: [Документация amoCRM OAuth 2.0](https://www.amocrm.ru/developers/content/oauth/oauth-2)

#### 2. Получение ID воронки и статуса

1. Перейдите в раздел **Настройки** → **Воронки и этапы**
2. Выберите нужную воронку
3. Скопируйте ID воронки из URL или через API
4. Укажите ID в переменной окружения `AMOCRM_PIPELINE_ID`
5. При необходимости укажите ID статуса в `AMOCRM_STATUS_ID`

#### 3. Получение ID кастомных полей

Для работы с кастомными полями необходимо получить их ID:

**Через API:**
```bash
curl -X GET "https://your-subdomain.amocrm.ru/api/v4/leads/custom_fields" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**Через интерфейс:**
1. Перейдите в раздел **Настройки** → **Настройка полей** → **Сделки** или **Контакты**
2. Найдите нужное поле и скопируйте его ID

**Стандартные поля:**
- Телефон и Email используют стандартные коды `PHONE` и `EMAIL` автоматически
- Не требуется указывать ID для стандартных полей

**Опциональные поля (для расширенной функциональности - только кастомные поля):**
- `AMOCRM_AGREEMENTS_FIELD_ID` - ID поля для договоренностей в сделках
- `AMOCRM_CLIENT_FACTS_FIELD_ID` - ID поля для фактов о клиенте
- `AMOCRM_SMS_TEXT_FIELD_ID` - ID поля для SMS текста
- `AMOCRM_CALL_DURATION_FIELD_ID` - ID поля для длительности звонка
- `AMOCRM_CALL_STARTED_FIELD_ID` - ID поля для времени начала звонка
- `AMOCRM_CALL_RECORD_URL_FIELD_ID` - ID поля для ссылки на запись звонка
- `AMOCRM_CALL_HISTORY_FIELD_ID` - ID поля для истории диалога
- `AMOCRM_AGREEMENTS_TIME_FIELD_ID` - ID поля для времени договоренности
- `AMOCRM_REGION_FIELD_ID` - ID поля для региона
- `AMOCRM_COMPANY_FIELD_ID` - ID поля для компании
- `AMOCRM_CONTACT_COMPANY_FIELD_ID` - ID поля компании в контактах
- `AMOCRM_CONTACT_CITY_FIELD_ID` - ID поля города в контактах

### Настройка маппинга полей

Сервер автоматически создает сущности в amoCRM на основе данных от Sasha AI:

- **Контакты** - создаются/обновляются по телефону
- **Сделки** - создаются с привязкой к контакту

#### Логика работы

1. **Если есть телефон** → создается/обновляется контакт в amoCRM
2. **Создается сделка** с названием из договоренностей или имени клиента
3. **Сделка привязывается к контакту** через `contacts_id`
4. **Кастомные поля заполняются** согласно настройкам в `mapping.js`

Все поля настраиваются в файле `mapping.js` и через переменные окружения.

## Запуск

### Локальный запуск

#### Режим разработки (с автоперезагрузкой):
```bash
npm run dev
```

#### Продакшн режим:
```bash
npm start
```

Сервер будет доступен по адресу: `http://localhost:${PORT}` (по умолчанию `http://localhost:3333`)

**Настройка портов:**
- `PORT` - порт на хосте, который будет доступен извне (для локального запуска и Docker)
- `CONTAINER_PORT` - порт внутри Docker контейнера (обычно совпадает с `PORT`)

### Запуск через Docker

#### Быстрый старт с docker-compose:

1. Убедитесь, что файл `.env` настроен (см. раздел "Установка")
2. Запустите контейнер:
```bash
docker-compose up -d
```

3. Просмотр логов:
```bash
docker-compose logs -f
```

4. Остановка:
```bash
docker-compose down
```

#### Запуск через Docker напрямую:

1. Соберите образ:
```bash
docker build -t sasha-webhook-amocrm .
```

2. Запустите контейнер:
```bash
docker run -d \
  --name sasha-webhook-amocrm \
  -p ${PORT:-3333}:${CONTAINER_PORT:-3333} \
  --env-file .env \
  --restart unless-stopped \
  sasha-webhook-amocrm
```

**Примечание:** Порты настраиваются через переменные окружения `PORT` и `CONTAINER_PORT` в файле `.env`. Формат маппинга портов: `внешний_порт:внутренний_порт`

3. Просмотр логов:
```bash
docker logs -f sasha-webhook-amocrm
```

4. Остановка:
```bash
docker stop sasha-webhook-amocrm
docker rm sasha-webhook-amocrm
```

## Endpoints

### POST /webhook
Принимает вебхуки от Sasha AI.

**Заголовки:**
- `X-Webhook-Signature` - HMAC SHA-256 подпись
- `X-Webhook-ID` - ID события
- `X-Webhook-Timestamp` - Время события
- `X-Call-List-ID` - ID колл-листа

**Ответ:** HTTP 200 OK с JSON объектом:
```json
{
  "success": true,
  "message": "Сделка успешно создана в amoCRM",
  "leadId": "12345678",
  "contactId": "87654321",
  "data": { ... }
}
```

### POST /test/amocrm/lead
Тестовый endpoint для отправки сделки в amoCRM вручную (без проверки подписи).

**Использование:**
```bash
curl -X POST http://localhost:3333/test/amocrm/lead \
  -H "Content-Type: application/json" \
  -d '{
    "contact": {
      "phone": "+79991234567"
    },
    "call": {
      "agreements": {
        "client_name": "Иван Иванов",
        "agreements": "Договорились о встрече"
      }
    }
  }'
```

## Использование с ngrok (для локальной разработки)

Для тестирования вебхуков локально используйте ngrok:

```bash
ngrok http 3333
```

Затем используйте полученный URL (например, `https://abc123.ngrok.io/webhook`) при создании вебхука в Sasha AI.

## Структура данных и маппинг

Сервер получает данные от Sasha AI и преобразует их в сущности amoCRM:

### Данные от Sasha AI:
- **Метаданные события** (id, type, timestamp, organizationId)
- **Данные звонка** (id, status, duration, startedAt, connectedAt, endedAt, recordUrl)
- **Договоренности** (isCommit, agreements, client_name, client_facts, interest_level, smsText, agreements_time)
- **Данные контакта** (id, phone, tags, additionalFields, dadataPhoneInfo)
- **Данные колл-листа** (id, name, status)

### Что создается в amoCRM:

**Контакт:**
- Имя из `call.agreements.client_name` или телефон
- Телефон из `contact.phone` (в кастомное поле)
- Email из `contact.additionalFields.email` (если настроено)
- Другие поля согласно настройкам

**Сделка:**
- Название из договоренностей или имени клиента
- Привязка к контакту через `contacts_id`
- Кастомные поля заполняются согласно настройкам
- Комментарии с деталями звонка (в поле `notes`)

Все поля настраиваются в файле `mapping.js` и через переменные окружения.

## Безопасность

- ✅ Проверка подписи HMAC SHA-256 (если установлен `WEBHOOK_SECRET`)
- ✅ Использование `timingSafeEqual` для защиты от timing attacks
- ✅ Логирование всех операций для аудита
- ✅ Использование OAuth 2.0 токенов для доступа к amoCRM API

## Устранение неполадок

### Вебхук не принимается
- Проверьте доступность сервера из интернета
- Убедитесь, что URL вебхука указан правильно
- Проверьте логи сервера

### Ошибка проверки подписи
- Убедитесь, что `WEBHOOK_SECRET` установлен правильно
- Проверьте, что используется сырое тело запроса (не парсится до проверки)

### Ошибка отправки в amoCRM

**Ошибка авторизации:**
- Проверьте правильность `AMOCRM_SUBDOMAIN` и `AMOCRM_ACCESS_TOKEN`
- Убедитесь, что токен не истек (токены OAuth 2.0 имеют срок действия)
- Проверьте права доступа токена (должен иметь права на создание сделок и контактов)

**Ошибка создания сделки:**
- Убедитесь, что `AMOCRM_PIPELINE_ID` указан правильно
- Проверьте, что воронка существует и активна
- Проверьте логи сервера для деталей ошибки

**Ошибка создания контакта:**
- Убедитесь, что `AMOCRM_PHONE_FIELD_ID` указан правильно
- Проверьте формат телефона (должен начинаться с +)
- Проверьте логи сервера для деталей ошибки

### Проверка работоспособности

После запуска проверьте health check:
```bash
curl http://localhost:${PORT:-3333}/health
```

**Пример:** Если `PORT=8080` в `.env`, то:
```bash
curl http://localhost:8080/health
```

## Дополнительная информация

### Формат данных amoCRM API

Сервер использует формат API v2/v4 amoCRM:
- **Создание контакта:** `POST /api/v2/contacts`
- **Создание сделки:** `POST /api/v2/leads`

Подробная документация: [amoCRM API Documentation](https://www.amocrm.ru/developers/content/crm_platform/leads-api)

### Ограничения amoCRM API

- Лимит запросов: 7 запросов в секунду для одного аккаунта
- Максимальный размер запроса: 50 MB
- Токены OAuth 2.0 имеют срок действия и требуют обновления

## Лицензия

ISC
